#include "oled.h"

// OLED显存
static uint16_t OLED_GRAM[128][8];

// 简单的8x8字库（只包含数字和部分字母）
// C51风格的8x8 ASCII字库
static const uint16_t Font10x10[][10] = {
    // 空格 (0x20)
    {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},
    
    // 数字 0-9
    {0x07C0,0x1C70,0x3818,0x3018,0x600C,0x600C,0x600C,0x3018,0x3818,0x1C70,0x07C0}, // 0
    {0x0180,0x0380,0x0780,0x0D80,0x1980,0x0180,0x0180,0x0180,0x0180,0x0180,0x07E0}, // 1
    {0x0F80,0x38E0,0x3030,0x0030,0x0060,0x00C0,0x0380,0x0E00,0x1800,0x3000,0x3FF0}, // 2
    {0x0F80,0x38E0,0x3030,0x0030,0x01C0,0x0070,0x0030,0x0030,0x3030,0x38E0,0x0F80}, // 3
    {0x00E0,0x01E0,0x0360,0x0660,0x0C60,0x1860,0x3060,0x3FF0,0x0060,0x0060,0x0060}, // 4
    {0x3FF0,0x3000,0x3000,0x3F80,0x30E0,0x0030,0x0030,0x0030,0x3030,0x38E0,0x0F80}, // 5
    {0x07C0,0x1C70,0x3018,0x3000,0x6F80,0x71C0,0x600C,0x600C,0x3018,0x1C70,0x07C0}, // 6
    {0x3FF0,0x3030,0x0060,0x00C0,0x0180,0x0300,0x0600,0x0C00,0x0C00,0x0C00,0x0C00}, // 7
    {0x0F80,0x38E0,0x3030,0x3030,0x19C0,0x0F80,0x31C0,0x6030,0x6030,0x31C0,0x0F80}, // 8
    {0x0F80,0x38E0,0x6030,0x6030,0x7070,0x3FE0,0x0030,0x6030,0x3060,0x1CE0,0x0780}, // 9
    
    // 大写字母 A-Z
    {0x0300,0x0780,0x0CC0,0x0CC0,0x1860,0x1860,0x3FF0,0x3030,0x6018,0x6018,0x6018}, // A
    {0x3F80,0x30E0,0x3030,0x3030,0x30E0,0x3F80,0x30E0,0x3030,0x3030,0x30E0,0x3F80}, // B
    {0x07C0,0x1C70,0x3018,0x6000,0x6000,0x6000,0x6000,0x6000,0x3018,0x1C70,0x07C0}, // C
    {0x3F00,0x31C0,0x3060,0x3030,0x3030,0x3030,0x3030,0x3030,0x3060,0x31C0,0x3F00}, // D
    {0x3FF0,0x3000,0x3000,0x3000,0x3FC0,0x3000,0x3000,0x3000,0x3000,0x3000,0x3FF0}, // E
    {0x3FF0,0x3000,0x3000,0x3000,0x3FC0,0x3000,0x3000,0x3000,0x3000,0x3000,0x3000}, // F
    {0x07C0,0x1C70,0x3018,0x6000,0x6000,0x63F0,0x6018,0x6018,0x3018,0x1C78,0x07D8}, // G
    {0x6018,0x6018,0x6018,0x6018,0x7FF8,0x6018,0x6018,0x6018,0x6018,0x6018,0x6018}, // H
    {0x07E0,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x07E0}, // I
    {0x01F8,0x0060,0x0060,0x0060,0x0060,0x0060,0x6060,0x6060,0x30C0,0x1FC0,0x0780}, // J
    {0x6018,0x6030,0x6060,0x60C0,0x6180,0x7E00,0x6700,0x6180,0x60C0,0x6060,0x6030}, // K
    {0x6000,0x6000,0x6000,0x6000,0x6000,0x6000,0x6000,0x6000,0x6000,0x6000,0x7FF0}, // L
    {0x6018,0x7038,0x7878,0x6CD8,0x6798,0x6318,0x6018,0x6018,0x6018,0x6018,0x6018}, // M
    {0x6018,0x7018,0x7818,0x6C18,0x6618,0x6318,0x6198,0x60D8,0x6078,0x6038,0x6018}, // N
    {0x07C0,0x1C70,0x3818,0x3018,0x600C,0x600C,0x600C,0x600C,0x3018,0x3818,0x1C70,0x07C0}, // O
    {0x3F80,0x30E0,0x3030,0x3030,0x3030,0x30E0,0x3F80,0x3000,0x3000,0x3000,0x3000}, // P
    {0x07C0,0x1C70,0x3818,0x3018,0x600C,0x600C,0x600C,0x60CC,0x3078,0x3878,0x1CF0,0x07D8}, // Q
    {0x3F80,0x30E0,0x3030,0x3030,0x3030,0x30E0,0x3F80,0x3180,0x30C0,0x3060,0x3030}, // R
    {0x0F80,0x38E0,0x3030,0x3000,0x3800,0x1E00,0x0780,0x00E0,0x0030,0x3030,0x38E0,0x0F80}, // S
    {0x3FF0,0x0C00,0x0C00,0x0C00,0x0C00,0x0C00,0x0C00,0x0C00,0x0C00,0x0C00,0x0C00}, // T
    {0x6018,0x6018,0x6018,0x6018,0x6018,0x6018,0x6018,0x6018,0x3030,0x1CE0,0x0780}, // U
    {0x600C,0x300C,0x3018,0x1818,0x1830,0x0C30,0x0C60,0x0660,0x06C0,0x03C0,0x0180}, // V
    {0x600C,0x600C,0x600C,0x600C,0x618C,0x318C,0x3BDC,0x1FF8,0x1C70,0x0C30,0x0C30}, // W
    {0x600C,0x3018,0x1830,0x0C60,0x06C0,0x0380,0x0380,0x06C0,0x0C60,0x1830,0x3018,0x600C}, // X
    {0x600C,0x3018,0x1830,0x0C60,0x06C0,0x0380,0x0180,0x0180,0x0180,0x0180,0x0180}, // Y
    {0x3FF0,0x3018,0x0030,0x0060,0x00C0,0x0180,0x0300,0x0600,0x0C00,0x1800,0x3000,0x3FF0}  // Z
};
// I2C写函数
static void I2C_WriteByte(uint16_t addr, uint16_t data)
{
    hi_i2c_data i2c_data = {0};
    uint16_t buf[2] = {0};
    
    buf[0] = addr;
    buf[1] = data;
    
    i2c_data.send_buf = buf;
    i2c_data.send_len = 2;
    
    hi_i2c_write(OLED_I2C_IDX, OLED_ADDRESS, &i2c_data);
}

// 写命令
static void OLED_WriteCmd(uint16_t cmd)
{
    I2C_WriteByte(OLED_CMD, cmd);
}

// 写数据
static void OLED_WriteData(uint16_t data)
{
    I2C_WriteByte(OLED_DATA, data);
}

// OLED初始化
void OLED_Init(void)
{
    // 初始化I2C
    // Hi3861的I2C0默认引脚是GPIO9(SCL)和GPIO10(SDA)
    hi_io_set_func(OLED_I2C_SCL_PIN, HI_IO_FUNC_GPIO_9_I2C0_SCL);
    hi_io_set_func(OLED_I2C_SDA_PIN, HI_IO_FUNC_GPIO_10_I2C0_SDA);
    
    hi_i2c_init(OLED_I2C_IDX, 400000);  // 400kHz
    
    // 延时等待OLED上电稳定
    usleep(100000);
    
    // OLED初始化序列
    OLED_WriteCmd(0xAE); // 关闭显示
    
    OLED_WriteCmd(0xD5); // 设置时钟分频因子
    OLED_WriteCmd(0x80); // 建议值
    
    OLED_WriteCmd(0xA8); // 设置驱动路数
    OLED_WriteCmd(0x3F); // 默认值(1/64)
    
    OLED_WriteCmd(0xD3); // 设置显示偏移
    OLED_WriteCmd(0x00); // 默认为0
    
    OLED_WriteCmd(0x40); // 设置显示开始行
    
    OLED_WriteCmd(0x8D); // 电荷泵设置
    OLED_WriteCmd(0x14); // 开启电荷泵
    
    OLED_WriteCmd(0x20); // 设置内存地址模式
    OLED_WriteCmd(0x02); // 页地址模式
    
    OLED_WriteCmd(0xA1); // 设置段重定义
    OLED_WriteCmd(0xC8); // 设置COM扫描方向
    
    OLED_WriteCmd(0xDA); // 设置COM硬件引脚配置
    OLED_WriteCmd(0x12); // 默认值
    
    OLED_WriteCmd(0x81); // 对比度设置
    OLED_WriteCmd(0xCF); // 默认值
    
    OLED_WriteCmd(0xD9); // 设置预充电周期
    OLED_WriteCmd(0xF1); // 默认值
    
    OLED_WriteCmd(0xDB); // 设置VCOMH电压倍率
    OLED_WriteCmd(0x40); // 默认值
    
    OLED_WriteCmd(0xA4); // 全局显示开启
    OLED_WriteCmd(0xA6); // 设置正常显示
    
    OLED_WriteCmd(0x2E); // 关闭滚动
    OLED_WriteCmd(0xAF); // 开启显示
    
    OLED_Clear();
    OLED_Refresh();
}

// 清屏
void OLED_Clear(void)
{
    memset(OLED_GRAM, 0, sizeof(OLED_GRAM));
}

// 开启显示
void OLED_Display_On(void)
{
    OLED_WriteCmd(0x8D); // 电荷泵设置
    OLED_WriteCmd(0x14); // 开启电荷泵
    OLED_WriteCmd(0xAF); // 开启显示
}

// 关闭显示
void OLED_Display_Off(void)
{
    OLED_WriteCmd(0x8D); // 电荷泵设置
    OLED_WriteCmd(0x10); // 关闭电荷泵
    OLED_WriteCmd(0xAE); // 关闭显示
}

// 刷新显存到OLED
void OLED_Refresh(void)
{
    uint16_t i, j;
    
    for (i = 0; i < 8; i++) {
        OLED_WriteCmd(0xB0 + i); // 设置页地址
        OLED_WriteCmd(0x00);     // 设置列地址低4位
        OLED_WriteCmd(0x10);     // 设置列地址高4位
        
        for (j = 0; j < 128; j++) {
            OLED_WriteData(OLED_GRAM[j][i]);
        }
    }
}

// 设置坐标
void OLED_SetPos(uint16_t x, uint16_t y)
{
    OLED_WriteCmd(0xB0 + y);                 // 设置页地址
    OLED_WriteCmd(((x & 0xF0) >> 4) | 0x10); // 设置列地址高4位
    OLED_WriteCmd(x & 0x0F);                 // 设置列地址低4位
}

// 画点
void OLED_DrawPoint(uint16_t x, uint16_t y, uint16_t mode)
{
    uint16_t page, bit_pos;
    
    if (x >= OLED_WIDTH || y >= OLED_HEIGHT) {
        return;
    }
    
    page = y / 8;
    bit_pos = y % 8;
    
    if (mode) {
        OLED_GRAM[x][page] |= 1 << bit_pos;
    } else {
        OLED_GRAM[x][page] &= ~(1 << bit_pos);
    }
}

// 显示一个字符
void OLED_ShowChar(uint16_t x, uint16_t y, char chr, uint16_t size)
{
    uint16_t temp, t, pos;
    const uint16_t *pfont = NULL;
    
    // 只支持8x8字体
    if (size != 10) {
        return;
    }
    
    // ASCII字符从空格(0x20)开始
    if (chr >= 0x20 && chr <= 0x7E) {
        pfont = Font10x10[chr - 0x20];  // 减去空格字符的偏移
        
        for (t = 0; t < 8; t++) {
            temp = pfont[t];
            for (pos = 0; pos < 8; pos++) {
                if (temp & 0x80) {
                    OLED_DrawPoint(x + t, y + pos, 1);
                } else {
                    OLED_DrawPoint(x + t, y + pos, 0);
                }
                temp <<= 1;
            }
        }
    }
}

// 显示字符串
void OLED_ShowString(uint16_t x, uint16_t y, char *str, uint16_t size)
{
    while (*str) {
        if (x > OLED_WIDTH - size) {
            x = 0;
            y += size;
        }
        
        if (y > OLED_HEIGHT - size) {
            y = x = 0;
            OLED_Clear();
        }
        
        OLED_ShowChar(x, y, *str, size);
        x += 8;
        str++;
    }
}

// 显示数字
void OLED_ShowNum(uint16_t x, uint16_t y, uint32_t num, uint16_t len, uint16_t size)
{
    char buf[12];
    char format[8];
    
    if (len > 10) len = 10;
    snprintf(format, sizeof(format), "%%%dd", len);
    snprintf(buf, sizeof(buf), format, num);
    OLED_ShowString(x, y, buf, size);
}